name: Vavoo M3U GÃ¼ncelle

on:
  schedule:
    - cron: '0 */10 * * *'  # Her 10 saatte bir
  workflow_dispatch:        # Elle baÅŸlatmak iÃ§in

jobs:
  update-vavoo:
    runs-on: ubuntu-latest

    steps:
      - name: Repo'yu klonla
        uses: actions/checkout@v4

      - name: Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Vavoo M3U dosyasÄ±nÄ± oluÅŸtur
        run: |
          import requests
          import re

          URL = "https://vavoo.to/channels"
          PROXY_BASE = "https://kerimmkirac-vavoo.hf.space/proxy/m3u?url=https://vavoo.to/play/{}/index.m3u8"
          LOGO_URL = "https://raw.githubusercontent.com/kerimmkirac/CanliTvListe/refs/heads/main/vavoo.png"
          OUTPUT_FILE = "vavoo.m3u"

          TURKISH_CHAR_MAP = str.maketrans({
              'Ã§': 'c', 'Ã‡': 'C',
              'ÄŸ': 'g', 'Ä': 'G',
              'Ä±': 'i', 'Ä°': 'I',
              'Ã¶': 'o', 'Ã–': 'O',
              'ÅŸ': 's', 'Å': 'S',
              'Ã¼': 'u', 'Ãœ': 'U'
          })

          NAME_CORRECTIONS = {
              "S NEMA": "SÄ°NEMA",
              "T RK": "TÃœRK",
              "M Z K": "MÃœZÄ°K",
              "A LE": "AÄ°LE",
              "AKS YON": "AKSÄ°YON",
              "KOMED": "KOMEDÄ°",
              "YERL": "YERLÄ°",
              "KURD": "KURDÄ°",
              "OCUK": "Ã‡OÃ‡UK",
              "CAY": "Ã‡AY",
              "D Ä N": "DOÄAN",
              "VINC": "VINCI",
              "KOMEDÄ°I": "KOMEDÄ°",
          }

          def normalize_tvg_id(name):
              name_ascii = name.translate(TURKISH_CHAR_MAP)
              return re.sub(r'\W+', '_', name_ascii.strip()).upper()

          def fix_channel_name(name):
              for wrong, correct in NAME_CORRECTIONS.items():
                  name = re.sub(wrong, correct, name, flags=re.IGNORECASE)
              return name.strip()

          def fetch_turkey_channels():
              response = requests.get(URL)
              if response.status_code != 200:
                  print("Hata: Kanal listesi alÄ±namadÄ±.")
                  return []

              channels = response.json()
              turkey_channels = [ch for ch in channels if ch.get("country") == "Turkey"]

              for ch in turkey_channels:
                  ch["name"] = fix_channel_name(ch.get("name", ""))

              return sorted(turkey_channels, key=lambda ch: ch.get("name", "").translate(TURKISH_CHAR_MAP).lower())

          def generate_m3u(channels):
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  f.write("#EXTM3U\n")
                  for ch in channels:
                      name = ch.get("name", "Unknown").strip()
                      tvg_id = normalize_tvg_id(name)
                      proxy_url = PROXY_BASE.format(ch.get("id"))

                      f.write(
                          f'#EXTINF:-1 tvg-name="{name}" tvg-language="TÃ¼rkÃ§e" '
                          f'tvg-country="TR" tvg-id="{tvg_id}" tvg-logo="{LOGO_URL}" '
                          f'group-title="Ulusal",{name}\n{proxy_url}\n'
                      )

              print(f"{len(channels)} Tane kanal bulundu â†’ '{OUTPUT_FILE}' dosyasÄ±na yazÄ±ldÄ±.")

          turkey_channels = fetch_turkey_channels()
          generate_m3u(turkey_channels)

      - name: DeÄŸiÅŸiklik kontrolÃ¼
        id: git-check
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit ve push (eÄŸer deÄŸiÅŸiklik varsa)
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git add vavoo.m3u
          git commit -m "ğŸ” vavoo.m3u gÃ¼ncellendi - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
